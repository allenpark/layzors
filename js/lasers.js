var laser_source;var laser_location;var laser_dir;function create_position(a,c){var b=Object();b.x=a;b.y=c;return b}function position_x(a){return a.x}function position_y(a){return a.y}function equal_position(b,a){return(position_x(b)==position_x(a)&&position_y(b)==position_y(a))}function create_vec(b,a){var c=Object();c.dx=b;c.dy=a;return c}function vec_dx(a){return a.dx}function vec_dy(a){return a.dy}function add_pos_vec(b,a){return create_position(position_x(b)+vec_dx(a),position_y(b)+vec_dy(a))}var DIR_UP=0;var DIR_RIGHT=1;var DIR_DOWN=2;var DIR_LEFT=3;function equal_dir(b,a){return b==a}function is_vertical_dir(a){return a==DIR_UP||a==DIR_DOWN}function is_horizontal_dir(a){return a==DIR_LEFT||a==DIR_RIGHT}function turn_right(a){return(a+1)%4}function turn_left(a){return(a+3)%4}var DIR_VECS=[create_vec(0,-1),create_vec(1,0),create_vec(0,1),create_vec(-1,0)];function dir_vec(a){return DIR_VECS[a]}function step_dir(b,a){return add_pos_vec(b,dir_vec(a))}function create_laser_state(c,a,d){var b=Object();b.live=c;b.position=a;b.direction=d;return b}function create_live_laser_state(a,b){return create_laser_state(true,a,b)}function create_dead_laser_state(b,a){return create_laser_state(false,b,a)}function laser_state_live(a){return a.live}function laser_state_pos(a){return a.position}function laser_state_dir(a){return a.direction}var OPEN=0;var WALL=1;var MIRROR_FORWARD=2;var MIRROR_BACKWARD=3;function get_laser_effect(d){var a=position_x(d);var c=position_y(d);if(a<0||c<0||a>=game.width||c>=game.height){return WALL}var b=game.field[a][c];if(b==TYPE.FORWARD||b==TYPE.FORWARD_FLIP){return MIRROR_FORWARD}else{if(b==TYPE.BACKWARD||b==TYPE.BACKWARD_FLIP){return MIRROR_BACKWARD}else{if(b==TYPE.WALL){return WALL}else{return OPEN}}}}function absorbs(a){return a==WALL}function reflects(a){return a==MIRROR_FORWARD||a==MIRROR_BACKWARD}function apply_laser_effect_reflection(a,b){if(b==MIRROR_FORWARD){if(is_vertical_dir(a)){return turn_right(a)}else{return turn_left(a)}}else{if(b==MIRROR_BACKWARD){if(is_vertical_dir(a)){return turn_left(a)}else{return turn_right(a)}}}throw"Bad reflection effect"}function create_laser_destination(a,b){return create_live_laser_state(step_dir(a,b),b)}function at_destination(b,a){return(equal_position(laser_state_pos(b),laser_state_pos(a))&&equal_dir(laser_state_dir(b),laser_state_dir(a)))}function step_laser_state(f){var e=laser_state_live(f);if(!e){throw"Stepping dead laser"}var d=laser_state_pos(f);var a=laser_state_dir(f);var g=get_laser_effect(d);var c=a;if(absorbs(g)){return create_dead_laser_state(d,a)}else{if(reflects(g)){var c=apply_laser_effect_reflection(a,g)}}var b=step_dir(d,c);return create_live_laser_state(b,c)}function simulate_laser(c,b){var a=[];var d=c;while(laser_state_live(d)&&!at_destination(d,b)){a.push(laser_state_pos(d));var e=step_laser_state(d);d=e}a.push(laser_state_pos(d));return{coords:a,win:at_destination(d,b)}}function test_from_allen_code(f){var c=create_position(f.source[0],f.source[1]);var e=allen_dir_to_lars_dir(f.source[2]);var d=create_live_laser_state(c,e);var g=create_position(f.goal[0],f.goal[1]);var b=f.goal[2];var a=create_laser_destination(g,b);return simulate_laser(d,a)}function allen_dir_to_lars_dir(a){return(a+2)%4}var DIES_LASER_GRAPHIC="l-dies";function get_laser_graphic_dir_id(a){switch(a){case DIR_UP:return"up";case DIR_RIGHT:return"right";case DIR_DOWN:return"down";case DIR_LEFT:return"left"}}function get_laser_change_graphic(a,b,c){if(!c){return DIES_LASER_GRAPHIC}return"l-"+get_laser_graphic_dir_id(a)+"_"+get_laser_graphic_dir_id(b)}function render_laser_step(e,f){var b=laser_state_pos(f);var a=laser_state_dir(e);var g=laser_state_live(f);var d=laser_state_dir(f);var c=get_laser_change_graphic(a,d,g);render_sprite(c,b)};