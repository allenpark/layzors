var TYPE={EMPTY:" ",PLAYER:"p",WALL:"0",FORWARD:"f",BACKWARD:"b",FORWARD_FLIP:"F",BACKWARD_FLIP:"B",BUTTON:".",SOURCE:"@",GOAL:"!",DOOR:"d",SLIDER:"s"};var deepCopy=function(a){if(a instanceof Array){var c=[];for(var b=0;b<a.length;b++){c.push(deepCopy(a[b]))}return c}else{return a}};var game={};game.init=function(b,c,a){this.active=true;this.cellWidth=30;this.cellHeight=30;this.lineWidth=2;this.cellWidth+=this.lineWidth;this.cellHeight+=this.lineWidth;this.scale=2;this.cellWidth*=this.scale;this.cellHeight*=this.scale;this.canvas=document.getElementById("canvas");this.context=canvas.getContext("2d");this.field=deepCopy(b.field);this.width=this.field.length;this.height=this.field[0].length;this.player=deepCopy(b.player);this.buttons=b.buttons===undefined?[]:deepCopy(b.buttons);this.sliders=b.sliders===undefined?[]:deepCopy(b.sliders);this.source=deepCopy(b.source);this.goal=deepCopy(b.goal);this.door=deepCopy(b.door);if(helpFunc!==undefined&&b.help!==undefined&&b.help!==""){helpFunc(b.help)}this.canvas.width=this.width*this.cellWidth+this.lineWidth-1;this.canvas.height=this.height*this.cellHeight+this.lineWidth-1;this.onFinish=c;this.takeTurn(true)};var makeOnKeyPress=function(a){return function(b){a.handleKeyPress(b)}};game.handleKeyPress=function(c){var b=c.keyCode;if(b==82){start();return}else{if(b==70||b==32||b==13){if(gameWon){window.location="../"+nextMap}}}if(!this.active){return}var a;if(b==37||b==65){a=[this.player[0]-1,this.player[1]]}else{if(b==38||b==87){a=[this.player[0],this.player[1]-1]}else{if(b==39||b==68){a=[this.player[0]+1,this.player[1]]}else{if(b==40||b==83){a=[this.player[0],this.player[1]+1]}else{return}}}}if(this.moveIfCan(a,this.playerMoveCallback,TYPE.PLAYER,this.player)){this.takeTurn()}};game.takeTurn=function(g){g=g||false;if(!g){this.flipMirrors()}var f;var d=false;var e=true;for(var c=0;c<this.buttons.length;c++){var b=this.buttons[c];if(!eq(b,this.player)&&this.field[b[0]][b[1]]===TYPE.EMPTY){e=false}}if(e){var a=test_from_allen_code(this);f=a.coords;d=a.win}if(this.buttons.length==0){var a=test_from_allen_code(this);f=a.coords;d=a.win}this.draw(f,d);if(f!==undefined&&this.died(f)){this.active=false;this.onFinish(false)}else{if(this.won(d)){this.active=false;this.onFinish(true)}}};game.flipMirrors=function(){for(var b=0;b<this.width;b++){for(var a=0;a<this.height;a++){if(this.field[b][a]==TYPE.FORWARD_FLIP){this.field[b][a]=TYPE.BACKWARD_FLIP}else{if(this.field[b][a]==TYPE.BACKWARD_FLIP){this.field[b][a]=TYPE.FORWARD_FLIP}}}}};game.won=function(a){return a&&(this.door===undefined||eq(this.player,this.door))};game.died=function(b){for(var a=0;a<b.length;a++){if(b[a].x==this.player[0]&&b[a].y==this.player[1]){return true}}return false};var eq=function(a,b){return a[0]===b[0]&&a[1]===b[1]};game.inBounds=function(a){return !(a[0]<0||a[0]>=game.width||a[1]<0||a[1]>=game.height)};game.isOnSlider=function(b){for(var a=0;a<this.sliders.length;a++){if(eq(b,this.sliders[a])){return true}}return false};game.playerMoveCallback=function(a,c,b){a.player=c;if(a.isOnSlider(a.player)){var e=[c[0]-b[0],c[1]-b[1]];var d=[c[0]+e[0],c[1]+e[1]];a.moveIfCan(d,a.playerMoveCallback,TYPE.PLAYER,c)}};game.mirrorMoveCallback=function(b,d,c){if(b.field[d[0]][d[1]]!==TYPE.EMPTY){console.log("PANIC!")}var a=b.field[c[0]][c[1]];b.field[c[0]][c[1]]=TYPE.EMPTY;b.field[d[0]][d[1]]=a;if(b.isOnSlider(d)){var f=[d[0]-c[0],d[1]-c[1]];var e=[d[0]+f[0],d[1]+f[1]];b.moveIfCan(e,b.mirrorMoveCallback,a,d)}};game.moveIfCan=function(b,h,d,a){if(!this.inBounds(b)){return false}var e=this.field[b[0]][b[1]];if(e==TYPE.EMPTY){h(this,b,a);return true}else{if(e==TYPE.WALL){return false}else{if(d==TYPE.PLAYER&&(e==TYPE.FORWARD||e==TYPE.BACKWARD||e==TYPE.FORWARD_FLIP||e==TYPE.BACKWARD_FLIP)){var g=[b[0]-this.player[0],b[1]-this.player[1]];var f=[b[0]+g[0],b[1]+g[1]];var c=this.moveIfCan(f,this.mirrorMoveCallback,e,b);if(c){h(this,b,a)}return c}}}return false};game.draw=function(z,K){this.canvas.width=this.canvas.width;this.context.lineWidth=this.lineWidth;this.context.beginPath();for(var F=0;F<=this.width;F++){this.context.moveTo(F*this.cellWidth,0);this.context.lineTo(F*this.cellHeight,this.canvas.height)}for(var E=0;E<=this.height;E++){this.context.moveTo(0,E*this.cellWidth);this.context.lineTo(this.canvas.width,E*this.cellHeight)}for(var F=0;F<this.width;F++){for(var E=0;E<this.height;E++){var d=this.field[F][E];var q=this.ftcX(F);var p=this.ftcY(E);if(d===TYPE.FORWARD||d===TYPE.FORWARD_FLIP){this.context.moveTo(q+11*this.scale,p+22*this.scale);this.context.lineTo(q+22*this.scale,p+11*this.scale)}else{if(d===TYPE.BACKWARD||d==TYPE.BACKWARD_FLIP){this.context.moveTo(q+11*this.scale,p+11*this.scale);this.context.lineTo(q+21*this.scale,p+21*this.scale)}else{if(d===TYPE.WALL){this.context.fillRect(q,p,this.cellWidth,this.cellHeight)}}}if(d===TYPE.FORWARD_FLIP||d===TYPE.BACKWARD_FLIP){var o=q+this.cellWidth/2-2*this.scale;var n=p+this.cellHeight/2-2*this.scale;this.context.fillRect(o,n,5*this.scale,5*this.scale)}}}this.context.stroke();var I=this.fotc(this.source);for(var B=0;B<5*this.scale;B++){this.context.beginPath();this.context.arc(I[0],I[1],B,Math.PI/2*(this.source[2]),Math.PI/2*(this.source[2]+2));this.context.stroke()}var J=this.fotc(this.goal);var t=5*this.scale;var G=7*this.scale;var c=[[-t,0],[0,-t],[-t,0],[0,-t]];var b=[[-t,G],[-G,-t],[-t,-G],[G,-t]];var f=[[t,0],[0,t],[t,0],[0,t]];var e=[[t,G],[-G,t],[t,-G],[G,t]];var H=[[0,G],[-G,0],[0,-G],[G,0]];this.context.beginPath();var p=this.goal[2];this.context.moveTo(J[0]+c[p][0],J[1]+c[p][1]);this.context.lineTo(J[0]+b[p][0],J[1]+b[p][1]);this.context.moveTo(J[0]+f[p][0],J[1]+f[p][1]);this.context.lineTo(J[0]+e[p][0],J[1]+e[p][1]);this.context.stroke();this.context.beginPath();this.context.arc(J[0]+H[p][0],J[1]+H[p][1],t,Math.PI/2*(p+2),Math.PI/2*(p+4));this.context.stroke();for(var F=0;F<this.buttons.length;F++){var a=this.buttons[F];var m=this.ftcX(a[0]);var l=this.ftcY(a[1]);this.context.strokeRect(m+6*this.scale,l+14*this.scale,20*this.scale,4*this.scale)}this.context.beginPath();var D=this.ftcX(this.player[0])+this.cellWidth/2;var C=this.ftcY(this.player[1])+this.cellHeight/2;this.context.arc(D,C,6*this.scale,0,Math.PI*2);this.context.fillStyle="white";this.context.fill();this.context.fillStyle="black";this.context.stroke();if(this.door!==undefined){var A=this.ftcX(this.door[0])+this.cellWidth/2;var v=this.ftcY(this.door[1])+this.cellHeight/2;if(K){this.context.moveTo(A,v-6*this.scale);this.context.lineTo(A+4*this.scale,v+8*this.scale);this.context.lineTo(A-6*this.scale,v-1*this.scale);this.context.lineTo(A+6*this.scale,v-1*this.scale);this.context.lineTo(A-4*this.scale,v+8*this.scale);this.context.lineTo(A,v-6*this.scale)}else{this.context.moveTo(A,v);this.context.arc(A,v-4*this.scale,4*this.scale,Math.PI/2,3*Math.PI/2-0.2,true);this.context.moveTo(A,v);this.context.lineTo(A,v+5*this.scale);this.context.moveTo(A,v+9*this.scale);this.context.arc(A,v+9*this.scale,1,0,Math.PI*2)}this.context.stroke()}for(var F=0;F<this.sliders.length;F++){var k=this.ftcX(this.sliders[F][0])+this.cellWidth/2;var g=this.ftcY(this.sliders[F][1])+this.cellHeight/2;var u=this.scale;this.context.moveTo(k,g+10*u);this.context.lineTo(k+4*u,g+6*u);this.context.lineTo(k+2*u,g+6*u);this.context.lineTo(k+2*u,g+2*u);this.context.lineTo(k+6*u,g+2*u);this.context.lineTo(k+6*u,g+4*u);this.context.lineTo(k+10*u,g);this.context.lineTo(k+6*u,g-4*u);this.context.lineTo(k+6*u,g-2*u);this.context.lineTo(k+2*u,g-2*u);this.context.lineTo(k+2*u,g-6*u);this.context.lineTo(k+4*u,g-6*u);this.context.lineTo(k,g-10*u);this.context.lineTo(k-4*u,g-6*u);this.context.lineTo(k-2*u,g-6*u);this.context.lineTo(k-2*u,g-2*u);this.context.lineTo(k-6*u,g-2*u);this.context.lineTo(k-6*u,g-4*u);this.context.lineTo(k-10*u,g);this.context.lineTo(k-6*u,g+4*u);this.context.lineTo(k-6*u,g+2*u);this.context.lineTo(k-2*u,g+2*u);this.context.lineTo(k-2*u,g+6*u);this.context.lineTo(k-4*u,g+6*u);this.context.lineTo(k,g+10*u)}this.context.stroke();game.drawLaser(z)};game.drawLaser=function(e){if(e===undefined||e.length===0){return}this.context.strokeStyle="red";var d=this.fotc(this.source);this.context.beginPath();this.context.moveTo(d[0],d[1]);for(var b=0;b<e.length;b++){var a=this.ftcX(e[b].x)+this.cellWidth/2;var c=this.ftcY(e[b].y)+this.cellHeight/2;this.context.lineTo(a,c)}this.context.stroke();this.context.strokeStyle="black";if(e.length>1){var a=this.ftcX(e[e.length-1].x);var c=this.ftcY(e[e.length-1].y);this.context.fillRect(a,c,this.cellWidth,this.cellHeight)}};game.fotc=function(e){var b=[this.cellWidth/2,this.cellWidth,this.cellWidth/2,0];var a=[0,this.cellHeight/2,this.cellHeight,this.cellHeight/2];var d=this.ftcX(e[0])+b[e[2]];var c=this.ftcY(e[1])+a[e[2]];return[d,c]};game.ftcX=function(a){return a*this.cellWidth};game.ftcY=function(a){return a*this.cellHeight};var onFinish=function(a){if(a){console.log("Yay!");text.innerHTML="<b>Click/Enter/Space to go to the next level.</b>";text.innerHTML='<a href="../'+nextMap+'">Click/Enter/Space for the next level ('+nextMap+").</a>";gameWon=true;if(currentMap>maps.length){}}else{console.log("Boo.");text.innerHTML="<b>You died! Try again.</b>"}};var helpFunc=function(b){var a=document.getElementById("help");a.innerHTML=b;a.style.display="block"};var start=function(){game.init(maps[currentMap-1],onFinish,helpFunc);gameWon=false;text.innerHTML="&nbsp;";level.innerHTML="<h2>Layzors Level: "+currentMap+"</h2>"};var text=document.getElementById("text");var level=document.getElementById("level");window.addEventListener("keydown",makeOnKeyPress(game),false);var gameWon=false;start();console.log("Whoa there! What are you doing looking at the console? Yes, we did not go through the effort of obfuscating our code. Just play the game :D");console.log("Your actions have been logged, and we know where you live. Back to the game with you!");